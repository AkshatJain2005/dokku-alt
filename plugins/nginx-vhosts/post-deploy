#!/usr/bin/env bash

source "$(dirname $0)/vars"

APP="$1"; PORT="$2"; INT_PORT="$3"
[[ "$INT_PORT" != "" ]] || INT_PORT="$APP_PORT"
WILDCARD_SSL="$DOKKU_ROOT/ssl"
SSL="$DOKKU_ROOT/$APP/ssl"

if [[ "$PORT" == "" ]] || [[ -f "$DOKKU_ROOT/$APP/NO_VHOST" ]]; then
  rm -f "$DOKKU_ROOT/$APP/nginx.conf"
  pluginhook nginx-pre-reload $APP
  sudo /etc/init.d/nginx reload > /dev/null
  exit 0
fi

hostnames_for_app "$APP"

if [[ "$hostname" != "" ]]; then
  if [[ -f "$SSL/server.crt" ]] && [[ -f "$SSL/server.key" ]]; then
    SSL_INUSE="$SSL"
  elif  [[ -f "$WILDCARD_SSL/server.crt" ]] && [[ -f "$WILDCARD_SSL/server.key" ]] && [[ $hostname = `openssl x509 -in $WILDCARD_SSL/server.crt -noout -subject | tr '/' '\n' | grep CN= | cut -c4-` ]]; then
    SSL_INUSE="$WILDCARD_SSL"
  fi

  export hostname
  export hostnames
  export redirect_hostnames
  export APP
  export PORT
  export INT_PORT
  export APP_ADDRESS="127.0.0.1:$PORT"

  export
    
  # ssl based nginx.conf
  if [[ -n "$SSL_INUSE" ]]; then
    export SSL_INUSE

    if [[ -x "$APP_DIR/nginx-conf-ssl" ]]; then
      "$APP_DIR/nginx-conf-ssl" > "$DOKKU_ROOT/$APP/nginx.conf"
    elif [[ -x "$DOKKU_ROOT/nginx-conf-ssl" ]]; then
      "$DOKKU_ROOT/nginx-conf-ssl" > "$DOKKU_ROOT/$APP/nginx.conf"
    else
      "$(dirname $0)/nginx-conf-ssl" > "$DOKKU_ROOT/$APP/nginx.conf"
    fi

    echo "https://$hostname" > "$DOKKU_ROOT/$APP/URL"
  else
    if [[ -x "$APP_DIR/nginx-conf" ]]; then
      "$APP_DIR/nginx-conf" > "$DOKKU_ROOT/$APP/nginx.conf"
    elif [[ -x "$DOKKU_ROOT/nginx-conf" ]]; then
      "$DOKKU_ROOT/nginx-conf" > "$DOKKU_ROOT/$APP/nginx.conf"
    else
      "$(dirname $0)/nginx-conf" > "$DOKKU_ROOT/$APP/nginx.conf"
    fi

    echo "http://$hostname" > "$DOKKU_ROOT/$APP/URL"
  fi

  pluginhook nginx-pre-reload $APP
  sudo /etc/init.d/nginx reload > /dev/null
fi
